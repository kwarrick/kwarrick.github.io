<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Iproute2 &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="//warrick.io/tags/iproute2/index.xml" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1 class="brand">warrick.io</h1>

  <div class="links">
    <i class="fa-twitter-square"></i>
    <i class="fa-github-square"></i>
  </div>

  
    <article>
      <h2><a href="//warrick.io/posts/multiple-interfaces-multiple-gateways/">multiple interfaces, multiple gateways</a></h2>
      <time>Oct 28, 2012</time>
      

<p>When configuring two interfaces, each on a different subnet, you must add an
additional routing table to isolate interface traffic (e.g. eth0 in, eth0 out).</p>

<h4 id="1-create-a-routing-table">1. Create a routing table.</h4>

<p>In our example we create a table named &lsquo;secondary&rsquo; with identifier 252:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">  $ <span class="nb">echo</span> <span class="s1">&#39;252 secondary&#39;</span> &gt;&gt; /etc/iproute2/rt_tables</code></pre></div>
<p>If you check out <code>/etc/iproute2/rt_tables</code> you&rsquo;ll see there are a few reserved
identifiers one of which is for the primary routing table, main:</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">#
# reserved values
#
255	local
254	main
253	default
0	unspec</code></pre></div>
<h4 id="2-add-rules-so-the-linux-kernel-will-use-our-new-table">2. Add rules so the Linux kernel will use our new table:</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ip rule add to <span class="m">10</span>.0.1.0/24 table secondary
$ ip rule add from <span class="m">10</span>.0.1.0/24 table secondary

$ ip rule list  
<span class="m">0</span>:	from all lookup <span class="nb">local</span> 
<span class="m">32764</span>:	from <span class="m">10</span>.0.1.1/24 lookup secondary 
<span class="m">32765</span>:	from all to <span class="m">10</span>.0.1.0/24 lookup secondary 
<span class="m">32766</span>:	from all lookup main 
<span class="m">32767</span>:	from all lookup default </code></pre></div>
<h4 id="3-add-an-entry-to-the-new-routing-table-mapping-the-subnet-traffic-to-the-correct-interface">3. Add an entry to the new routing table mapping the subnet traffic to the correct interface:</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ip route add <span class="m">10</span>.0.1.0/24 dev eth0 src <span class="m">10</span>.0.1.5 table secondary</code></pre></div>
<h4 id="4-add-an-entry-specifying-the-gateway-of-the-subnet">4. Add an entry specifying the gateway of the subnet:</h4>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ip route default via <span class="m">10</span>.0.1.1 dev eth0 table secondary</code></pre></div>
<p>That is it, now traffic on 10.0.1.0/24 will be routed through the secondary
table, and we can take a look at our routes:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ip route list table secondary
default via <span class="m">10</span>.0.1.1 dev eth0 
<span class="m">10</span>.0.1.0/24 dev eth0  scope link  src <span class="m">10</span>.0.1.5</code></pre></div>
<p>In Ubuntu, if you want this configuration to persist across boots you&rsquo;ll need
to add it your your <code>/etc/network/interfaces</code> config:</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">auto eth0
iface eth0 inet static
address 10.0.1.5
netmask 255.255.255.0
up ip rule add to 10.0.1.0/24 lookup secondary
up ip rule add from 10.0.1.0/24 lookup secondary
up ip route add 10.0.1.0/24 dev eth0 src 10.0.1.5 table secondary
up ip route add default via 10.0.1.1 dev eth0 table secondary</code></pre></div>
<p><a href="http://segv.me/posts/iproute2">http://segv.me/posts/iproute2</a><br />
<a href="http://kindlund.wordpress.com/2007/11/19/configuring-multiple-default-routes-in-linux/">http://kindlund.wordpress.com/2007/11/19/configuring-multiple-default-routes-in-linux/</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/iproute2/">iproute2</a></h2>
      <time>Apr 21, 2012</time>
      <p>I was surprised to find out that ifconfig and route are actually deprecated,
despite their ubiquity.</p>

<p>Even more unfortunate, their replacement, namely the ip command, doesn&rsquo;t seem
to have any concern for the readability of its output.</p>

<p>Here is how you would statically assign an IP, Netmask, Gateway, and DNS
servers with ifconfig and route and the equivalent commands in ip:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ifconfig eth0 up

$ ip link <span class="nb">set</span> eth0 up</code></pre></div>
<p>Configure your IP and Netmask:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ ifconfig eth0 <span class="m">192</span>.168.1.3 netmask <span class="m">255</span>.255.255.0

$ ip addr add <span class="m">192</span>.168.1.3/24 dev eth0</code></pre></div>
<p>Configure a route to your default Gateway:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ route add default gw <span class="m">192</span>.168.1.1

$ ip route add default via <span class="m">192</span>.168.1.1</code></pre></div>
    </article>
  

  </body>
</html>
