<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Postgres &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="//warrick.io/tags/postgres/index.xml" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1 class="brand">warrick.io</h1>

  <div class="links">
    <i class="fa-twitter-square"></i>
    <i class="fa-github-square"></i>
  </div>

  
    <article>
      <h2><a href="//warrick.io/posts/postgres-histogram/">postgres histogram</a></h2>
      <time>May 22, 2014</time>
      <p>A huge thank you for this little gem &mdash; a quick and dirty histogram in
PostgreSQL:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">WITH</span> 
<span class="n">stats</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
      <span class="k">min</span><span class="p">(</span><span class="n">__value__</span><span class="p">)</span>
    <span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">__value__</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">__table__</span>
<span class="p">),</span> 
<span class="n">histogram</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
    <span class="n">WIDTH_BUCKET</span><span class="p">(</span><span class="n">__value__</span><span class="p">,</span> <span class="k">min</span><span class="p">,</span> <span class="k">max</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>  <span class="c1">--&lt;&lt;&lt;&lt;&lt;
</span><span class="c1"></span>    <span class="k">AS</span> <span class="n">bucket</span>
  <span class="p">,</span> <span class="k">MIN</span><span class="p">(</span><span class="n">__value__</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">MAX</span><span class="p">(</span><span class="n">__value__</span><span class="p">)</span>
  <span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> 
    <span class="k">AS</span> <span class="n">freq</span>
  <span class="k">FROM</span> <span class="n">__table__</span>
  <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">stats</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">bucket</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">bucket</span>
<span class="p">)</span>
<span class="k">SELECT</span> 
    <span class="n">bucket</span>
  <span class="p">,</span> <span class="k">min</span>
  <span class="p">,</span> <span class="k">max</span>
  <span class="p">,</span> <span class="n">freq</span>
  <span class="p">,</span> <span class="n">REPEAT</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">freq</span><span class="p">::</span><span class="nb">FLOAT</span> <span class="o">/</span> <span class="k">max</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="n">over</span><span class="p">()</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)::</span><span class="nb">INT</span><span class="p">)</span> 
    <span class="k">AS</span> <span class="n">bar</span>
<span class="k">FROM</span> <span class="n">histogram</span>
<span class="p">;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"> bucket |  min  |  max  |  freq  |              bar
--------+-------+-------+--------+--------------------------------
      1 |     0 |  8517 | 294826 | ******************************
      2 |  8577 | 16400 |  73992 | ********
      3 | 17563 | 25200 |   8202 | *
      4 | 26219 | 33651 |    853 |
      5 | 34560 | 42600 |   1312 |
      6 | 43200 | 51063 |   2592 |
      7 | 53104 | 59037 |      9 |
      8 | 60000 | 68400 |     17 |
      9 | 68577 | 76833 |     54 |
     10 | 77060 | 85499 |     60 |</code></pre></div>
<p>Visualize the frequency distribution of some <code>__value__</code> in your <code>__table__</code>,
and adjust the number of buckets to increase the resolution.</p>

<p><a href="http://tapoueh.org/blog/2014/02/21-PostgreSQL-histogram.html">http://tapoueh.org/blog/2014/02/21-PostgreSQL-histogram.html</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/psql-editor-highlighting/">syntax highlighting in psql vim session</a></h2>
      <time>Mar 23, 2014</time>
      <p>If you spend a lot of time using <code>psql</code>, you should definitely use the <code>\e</code> and
<code>\ef</code> commands to edit queries and functions in VIM.</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">\e [FILE] [LINE]  edit the query buffer (or file) with external editor 
\ef [FUNCNAME [LINE]]  edit function definition with external editor</code></pre></div>
<p>One annoyance is that, because the temporary file created doesn&rsquo;t have a <code>.sql</code>
extension, VIM doesn&rsquo;t enable syntax highlighting.</p>

<p>Here is a simple autocmd that will turn syntax highlighting on that match
psql&rsquo;s filename pattern:</p>
<div class="highlight"><pre class="chroma"><code class="language-vim" data-lang="vim"><span class="nx">autocmd</span> <span class="nx">BufRead</span> <span class="sr">/tmp/</span><span class="nx">psql</span>.<span class="nx">edit</span>.* <span class="nx">setlocal</span> <span class="nx">ft</span><span class="p">=</span><span class="nx">sql</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/postgres-dblink/">postgres dblink</a></h2>
      <time>Dec 4, 2013</time>
      <p>Connect to and query a remote PostgreSQL database from a local database.</p>

<p>First install the dblink extension and enable it for your database, e.g.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get install postgresql-contrib-9.1
sudo -u postgres psql -c <span class="s1">&#39;CREATE EXTENSION dblink;&#39;</span> foo</code></pre></div>
<p>Then connect to the remote database with the dblink_connect function:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">SELECT 
dblink_connect<span class="o">(</span><span class="s1">&#39;hostaddr=10.0.1.1 port=5432 dbname=foo user=bar password=baz&#39;</span><span class="o">)</span><span class="p">;</span></code></pre></div>
<p><a href="http://www.postgresql.org/docs/9.1/static/contrib-dblink-connect.html">http://www.postgresql.org/docs/9.1/static/contrib-dblink-connect.html</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/kill-postgres-query/">kill postgres query</a></h2>
      <time>Oct 29, 2013</time>
      <p>Find the PID of the query from a system utility like top or htop, or from the
&ldquo;pg_catalog.pg_stat_activity&rdquo; table.</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo -u postgres psql </code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">postgres</span><span class="o">=</span># SELECT pg_cancel_backend<span class="o">(</span><span class="m">28710</span><span class="o">)</span><span class="p">;</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-in-postgres/">python in postgres</a></h2>
      <time>Oct 19, 2013</time>
      <p>Installing and adding Python to your PostgreSQL database in Ubuntu:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get install postgresql-plpython-9.1
sudo -u postgres psql -c <span class="s1">&#39;CREATE EXTENSION plpythonu;&#39;</span> dbname</code></pre></div>
<p>Check that it was installed:</p>
<div class="highlight"><pre class="chroma"><code class="language-psql" data-lang="psql">psql -c &#39;\dL&#39; dbname
       List of languages
   Name    |  Owner   | Trusted 
-----------+----------+---------
 plpgsql   | postgres | t 
 plpythonu | postgres | f 
(2 rows)</code></pre></div>
<p>Keep in mind that Python is an &lsquo;untrusted&rsquo; language meaning that functions
written in PL/Pythonu execute in an administrative context. For this reason,
Python functions can only be created by an administrator and special care
should be taken that nothing damaging or nefarious can be done with the
function by non administrator users of the database.</p>

<p>Now, you can declare a function in Python as an administrator.</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">arg</span> <span class="nb">text</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">text</span> <span class="k">AS</span>
<span class="err">$$</span>
  <span class="n">import</span> <span class="n">random</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="err">$$</span>
<span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-psql" data-lang="psql">=&gt; SELECT shuffle(&#39;foo bar&#39;);
 shuffle 
---------
 oa forb
(1 row)</code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/postgres-index-usage/">postgres index usage</a></h2>
      <time>Sep 9, 2013</time>
      <p>Awesome article on <a href="http://www.craigkerstiens.com/2012/10/01/understanding-postgres-performance/">understanding postgres performance</a> had this little nugget, which gives you the tables in your database with the percentage of time they use an index:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> 
  <span class="n">relname</span><span class="p">,</span> 
  <span class="mi">100</span> <span class="o">*</span> <span class="n">idx_scan</span> <span class="o">/</span> <span class="p">(</span><span class="n">seq_scan</span> <span class="o">+</span> <span class="n">idx_scan</span><span class="p">)</span> <span class="n">percent_of_times_index_used</span><span class="p">,</span> 
  <span class="n">n_live_tup</span> <span class="n">rows_in_table</span>
<span class="k">FROM</span> 
  <span class="n">pg_stat_user_tables</span>
<span class="k">WHERE</span> 
  <span class="n">seq_scan</span> <span class="o">+</span> <span class="n">idx_scan</span> <span class="o">&gt;</span> <span class="mi">0</span> 
<span class="k">ORDER</span> <span class="k">BY</span> 
  <span class="n">n_live_tup</span> <span class="k">DESC</span><span class="p">;</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/postgres-database-and-table-size/">postgres database and table size</a></h2>
      <time>Jun 5, 2013</time>
      <div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_database_size</span><span class="p">(</span><span class="s1">&#39;foo_db&#39;</span><span class="p">));</span>
<span class="k">SELECT</span> <span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_total_relation_size</span><span class="p">(</span><span class="s1">&#39;bar_table&#39;</span><span class="p">));</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/coalesce/">coalesce</a></h2>
      <time>Jan 29, 2013</time>
      <p>I have never encountered the <code>COALESCE</code> function in SQL, so I feel the need to
take note of it, <code>COALESCE(value, ...)</code> returns the first non-NULL value in the
argument list.</p>

<p><a href="http://www.postgresql.org/docs/9.1/static/functions-conditional.html">http://www.postgresql.org/docs/9.1/static/functions-conditional.html</a><br />
<a href="http://dev.mysql.com/doc/refman/5.0/en/comparison-operators.html#function_coalesce">http://dev.mysql.com/doc/refman/5.0/en/comparison-operators.html#function_coalesce</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/week-of-year-in-python-and-in-postgres/">week of year in python and in postgres</a></h2>
      <time>Dec 4, 2012</time>
      <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">today</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="k">EXTRACT</span><span class="p">(</span><span class="n">WEEK</span> <span class="k">FROM</span> <span class="k">TIMESTAMP</span> <span class="s1">&#39;2012-12-04 20:38:40&#39;</span><span class="p">);</span></code></pre></div>
    </article>
  

  </body>
</html>
