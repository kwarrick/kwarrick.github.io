<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Ssh &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="//warrick.io/tags/ssh/index.xml" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1 class="brand">warrick.io</h1>

  <div class="links">
    <i class="fa-twitter-square"></i>
    <i class="fa-github-square"></i>
  </div>

  
    <article>
      <h2><a href="//warrick.io/posts/fix-ssh-logins-v2/">fix slow ssh logins v2</a></h2>
      <time>Mar 17, 2014</time>
      <p>Newer versions of OpenSSH attempt to reverse resolve client IP addresses. This
can cause slow ssh connections if the client IP does not reverse resolve as the
DNS request will be attempted multiple times and timeout each time.</p>

<p>To fix the problem, disable it in your <code>/etc/ssh/sshd_config</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">  UseDNS no</code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/pam-exec/">pam exec</a></h2>
      <time>Oct 29, 2013</time>
      <p>PAM, the Linux Pluggable Authentication Modules, allows you to execute programs
and scripts when SSH sessions are opened and closed.</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt"># /etc/pam.d/sshd
session optional        pam_exec.so     /path/to/script.sh</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /path/to/script.sh
</span><span class="c1"></span>
<span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="k">if</span> <span class="o">[</span> <span class="nv">$PAM_TYPE</span> <span class="o">=</span> <span class="s2">&#34;open_session&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="c1"># 
</span><span class="c1"></span><span class="k">fi</span>
<span class="nb">exit</span> <span class="m">0</span></code></pre></div>
<p><strong>WARNING:</strong><br />
Botching your script or failing to return 0 will cause SSH login
to fail. Don&rsquo;t lock yourself out, test your script!</p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/reverse-ssh-tunnel/">reverse ssh tunnel</a></h2>
      <time>Jan 18, 2013</time>
      <p>When I have a machine behind a NAT that I know I&rsquo;ll need remote access to over
the weekend, I add this rudimentary little script:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="nv">RUSER</span><span class="o">=</span>warrick
<span class="nv">LPORT</span><span class="o">=</span><span class="m">5555</span>
<span class="nv">RHOST</span><span class="o">=</span><span class="s2">&#34;74.207.228.87&#34;</span>

<span class="nv">COMMAND</span><span class="o">=</span><span class="s2">&#34;ssh -N -f -R </span><span class="si">${</span><span class="nv">LPORT</span><span class="si">}</span><span class="s2">:localhost:22 </span><span class="si">${</span><span class="nv">RUSER</span><span class="si">}</span><span class="s2">@</span><span class="si">${</span><span class="nv">RHOST</span><span class="si">}</span><span class="s2">&#34;</span>
pgrep -f -x <span class="s2">&#34;</span><span class="nv">$COMMAND</span><span class="s2">&#34;</span> &gt; /dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nv">$COMMAND</span></code></pre></div>
<p>I then add this to the crontab, which runs the script every 5 minutes:</p>
<div class="highlight"><pre class="chroma"><code class="language-cron" data-lang="cron">#  KEY
#  +---------------- minute (0 - 59)
#  |  +------------- hour (0 - 23)
#  |  |  +---------- day of month (1 - 31)
#  |  |  |  +------- month (1 - 12)
#  |  |  |  |  +---- day of week (0 - 7 with Sunday=0 &amp; 7)
#  |  |  |  |  |
#  *  *  *  *  *  command to be executed
  */5 *  *  *  *  bash /home/user/rsshchk.sh</code></pre></div>
<p>So, now I know I can ssh into the $RHOST and then ssh to the localhost at
$LPORT, allowing me access to the NAT&rsquo;d box:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">ssh -p LPORT RUSER@locahost</code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/fix-slow-ssh-logins/">fix slow ssh logins</a></h2>
      <time>Apr 8, 2012</time>
      <p><a href="http://unix.stackexchange.com/questions/5621/how-to-speed-my-too-slow-ssh-login">http://unix.stackexchange.com/questions/5621/how-to-speed-my-too-slow-ssh-login</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/encrypt-small-files-with-ssh-keys/">encrypt small files with ssh keys</a></h2>
      <time>Mar 2, 2012</time>
      <p>Convert RSA public key and private key to PEM format:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ openssl rsa -in ~/.ssh/id_rsa -outform pem &gt; 
id_rsa.pem

$ openssl rsa -in ~/.ssh/id_rsa -pubout -outform pem &gt;
id_rsa.pub.pem</code></pre></div>
<p>Encrypting a file with your public key:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ openssl rsautl -encrypt -pubin -inkey id_rsa.pub.pem <span class="se">\
</span><span class="se"></span>-in file.txt -out file.enc</code></pre></div>
<p>Decrypting the file with your private key:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ openssl rsautl -decrypt -inkey id_rsa.pem <span class="se">\
</span><span class="se"></span>-in file.enc -out file.txt</code></pre></div>
<p>Of course, this is asymmetric encryption and your file must be less than or
equal in size to your key!</p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/ssh-config/">SSH config</a></h2>
      <time>Dec 12, 2011</time>
      <p>OpenSSH allows you to add configuration directives to <code>~/.ssh/config</code> with aliases for long hostnames or IP addresses:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF &gt;&gt; ~/.ssh/config
</span><span class="s">Host segv                     # desired alias
</span><span class="s">    HostName segv.me          # ip address works too
</span><span class="s">    Port 22
</span><span class="s">    User foo
</span><span class="s">    LocalForward localhost:57005 192.168.0.2:57005
</span><span class="s">    IdentityFile ~/.ssh/auxiliary_rsa
</span><span class="s">EOF</span></code></pre></div>
<p>This solution is better than using <code>/etc/hosts</code> for obvious reasons. There are
a great number of options that allow you choose everything from username to
encryption cipher preferences on a host-by-host basis.  <code>man ssh_config</code></p>

<p>I&rsquo;ve added a nasty little bashism too, as a bonus:<br />
<a href="http://tldp.org/LDP/abs/html/here-docs.html">http://tldp.org/LDP/abs/html/here-docs.html</a></p>

    </article>
  

  </body>
</html>
