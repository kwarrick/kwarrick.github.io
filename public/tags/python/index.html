<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Python &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="//warrick.io/tags/python/index.xml" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1 class="brand">warrick.io</h1>

  <div class="links">
    <i class="fa-twitter-square"></i>
    <i class="fa-github-square"></i>
  </div>

  
    <article>
      <h2><a href="//warrick.io/posts/partial-uniq-with-lru-cache/">partial uniq using a lru cache</a></h2>
      <time>Apr 2, 2014</time>
      <p>Recently, I was faced with the challenge of removing duplicate lines from a
number of large data files.</p>

<p>Typically, I use a combination or <code>sort</code> and <code>uniq</code> or just <code>sort -u</code>, but in
this circumstance many duplicate lines were close together.</p>

<p>I found that, first, partially filtering duplicates by using a LRU cache to
keep track of and omit recently seen lines doubled the speed.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># file: lru-uniq.py</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="kn">from</span> <span class="nn">repoze.lru</span> <span class="kn">import</span> <span class="n">LRUCache</span>

<span class="n">size</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="nb">input</span><span class="p">():</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">line</span><span class="p">,</span>
  <span class="n">cache</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">time</span> sort ns <span class="p">|</span> uniq <span class="p">|</span> wc -l
  <span class="m">936442</span>
real	1m58.768s

$ <span class="nb">time</span> ./lru-uniq.py ns <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> wc -l
  <span class="m">936442</span>
real	0m55.236s</code></pre></div>
<p>I wanted to speed it up a little more, and it turns out that although I have
never written a program in Go before it was the fastest way to write a compiled
version.</p>

<p>So, here it is, and I&rsquo;m sure it is terrible Go.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;os&#34;</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;bufio&#34;</span>
  <span class="s">&#34;github.com/golang/groupcache/lru&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cache</span> <span class="o">:=</span> <span class="nx">lru</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
  <span class="nx">stdin</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stdin</span><span class="p">.</span><span class="nx">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">hit</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">hit</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> 
  <span class="p">}</span>
<span class="p">}</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">time</span> ./lru-uniq &lt; ns <span class="p">|</span> sort <span class="p">|</span> uniq <span class="p">|</span> wc -l
  <span class="m">936442</span>
real	0m35.218s</code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-in-postgres/">python in postgres</a></h2>
      <time>Oct 19, 2013</time>
      <p>Installing and adding Python to your PostgreSQL database in Ubuntu:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">sudo apt-get install postgresql-plpython-9.1
sudo -u postgres psql -c <span class="s1">&#39;CREATE EXTENSION plpythonu;&#39;</span> dbname</code></pre></div>
<p>Check that it was installed:</p>
<div class="highlight"><pre class="chroma"><code class="language-psql" data-lang="psql">psql -c &#39;\dL&#39; dbname
       List of languages
   Name    |  Owner   | Trusted 
-----------+----------+---------
 plpgsql   | postgres | t 
 plpythonu | postgres | f 
(2 rows)</code></pre></div>
<p>Keep in mind that Python is an &lsquo;untrusted&rsquo; language meaning that functions
written in PL/Pythonu execute in an administrative context. For this reason,
Python functions can only be created by an administrator and special care
should be taken that nothing damaging or nefarious can be done with the
function by non administrator users of the database.</p>

<p>Now, you can declare a function in Python as an administrator.</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">arg</span> <span class="nb">text</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="nb">text</span> <span class="k">AS</span>
<span class="err">$$</span>
  <span class="n">import</span> <span class="n">random</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
  <span class="n">random</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="err">$$</span>
<span class="k">LANGUAGE</span> <span class="n">plpythonu</span><span class="p">;</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-psql" data-lang="psql">=&gt; SELECT shuffle(&#39;foo bar&#39;);
 shuffle 
---------
 oa forb
(1 row)</code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/consumer-decorator/">consumer decorator</a></h2>
      <time>Oct 18, 2013</time>
      <p>Just stumbled across this little gem, and I don&rsquo;t want to forget about it. Here
is a decorator that takes care of the ugliness in first call to <code>.next()</code>,
necessary for receiving coroutines in Python.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">consumer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">c</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="n">c</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">c</span>
  <span class="k">return</span> <span class="n">start</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@consumer</span>
<span class="k">def</span> <span class="nf">recv_count</span><span class="p">():</span>
 <span class="k">try</span><span class="p">:</span>
   <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
     <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield</span><span class="p">)</span> <span class="c1"># Yield expression</span>
     <span class="k">print</span> <span class="sa"></span><span class="s2">&#34;T-minus&#34;</span><span class="p">,</span> <span class="n">n</span>
 <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
   <span class="k">print</span> <span class="sa"></span><span class="s2">&#34;Kaboom!&#34;</span></code></pre></div>
<p><a href="http://www.dabeaz.com/coroutines/Coroutines.pdf">http://www.dabeaz.com/coroutines/Coroutines.pdf</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/map-reduce-a-csv-file/">map reduce a csv file</a></h2>
      <time>Jun 8, 2013</time>
      <p>Map-reduce a CSV files using the incredible UNIX <strong>sort</strong> utility in just
~24 LOC.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># kwarrick@uga.edu</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>

<span class="k">def</span> <span class="nf">map_reduce_csv</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
  <span class="sa"></span><span class="s2">&#34;&#34;&#34; Map-reduce CSV file using UNIX sort utility. &#34;&#34;&#34;</span>
  <span class="n">sort</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="p">[</span><span class="sa"></span><span class="s1">&#39;/usr/bin/sort&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;-t,&#39;</span><span class="p">],</span> 
    <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;LC_ALL&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;C&#39;</span><span class="p">},</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="c1"># map and sort</span>
  <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">mapper</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

  <span class="n">sort</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1"># group and reduce</span>
  <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">reducer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>

  <span class="n">sort</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
  <span class="sa"></span><span class="s2">&#34;&#34;&#34; Example task simply outputs sorted input file. &#34;&#34;&#34;</span>
  <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      
  <span class="k">def</span> <span class="nf">mapper</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">row</span>

  <span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">value</span>

  <span class="n">map_reduce_csv</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">fileinput</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;output.csv&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">identity</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="nb">input</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/working-with-large-web-resources-in-python/">working with large web resources in python</a></h2>
      <time>Apr 15, 2013</time>
      <p>Saving the file to disk.<sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></code></pre></div>
<p>Reading GZIP compressed CSV files:<sup class="footnote-ref" id="fnref:2"><a rel="footnote" href="#fn:2">2</a></sup></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">gzip</span>

<span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">)</span>
  <span class="n">header</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="nb">next</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
    <span class="c1"># ...</span></code></pre></div><div class="footnotes">

<hr />

<ol>
<li id="fn:1"><a href="http://stackoverflow.com/questions/9252812/using-csvreader-against-a-gzipped-file-in-python">http://stackoverflow.com/questions/9252812/using-csvreader-against-a-gzipped-file-in-python</a>
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2"><a href="http://stackoverflow.com/questions/1517616/stream-large-binary-files-with-urllib2-to-file">http://stackoverflow.com/questions/1517616/stream-large-binary-files-with-urllib2-to-file</a>
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-equivalent-to-argf-or-diamond-operator/">python equivalent to argf or diamond operator</a></h2>
      <time>Feb 3, 2013</time>
      <p>Ruby has <a href="http://www.ruby-doc.org/core-1.9.3/ARGF.html">ARGF</a> and Perl has the <a href="http://perldoc.perl.org/perlop.html#I%2fO-Operators">diamond operator</a>, but what convenience
object or operator does Python provide for reading from files provided on the
command line or <code>stdin</code>?</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">fileinput</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="nb">input</span><span class="p">():</span>
    <span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></code></pre></div>
<p><a href="http://docs.python.org/2/library/fileinput.html">http://docs.python.org/2/library/fileinput.html</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/redis-lru-cache-decorator-in-python/">redis lru cache decorator in python</a></h2>
      <time>Dec 9, 2012</time>
      <p>Python 3 offers a brilliant decorator that adds a Least Recently Used (LRU)
cache to any function:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_pep</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="sa"></span><span class="s1">&#39;Retrieve text of a Python Enhancement Proposal&#39;</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;http://www.python.org/dev/peps/pep-</span><span class="si">%04d</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="n">num</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa"></span><span class="s1">&#39;Not Found&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">308</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">289</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">9991</span><span class="p">:</span>
<span class="o">...</span>     <span class="n">pep</span> <span class="o">=</span> <span class="n">get_pep</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pep</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">get_pep</span><span class="o">.</span><span class="n">cache_info</span><span class="p">())</span>
<span class="n">CacheInfo</span><span class="p">(</span><span class="n">hits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">misses</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">currsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span></code></pre></div>
<p>Functools has been <a href="https://github.com/MiCHiLU/python-functools32">back-ported</a> to Python 2.7; however, I was interested in
creating a similar LRU cache decorator but leveraging a Redis server so that
the cache can be shared across several worker programs. The cache will be
semi-persistant allowing workers to restart as necessary.</p>

<p>It turned out to only take 50 lines of Python, so I am sharing it:<br />
<a href="https://gist.github.com/4247343">https://gist.github.com/4247343</a></p>

<p><a href="http://docs.python.org/3/library/functools.html#functools.lru_cache">http://docs.python.org/3/library/functools.html#functools.lru_cache</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/week-of-year-in-python-and-in-postgres/">week of year in python and in postgres</a></h2>
      <time>Dec 4, 2012</time>
      <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">today</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="k">EXTRACT</span><span class="p">(</span><span class="n">WEEK</span> <span class="k">FROM</span> <span class="k">TIMESTAMP</span> <span class="s1">&#39;2012-12-04 20:38:40&#39;</span><span class="p">);</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/x-days-ago-in-python/">x days ago in python</a></h2>
      <time>Oct 23, 2012</time>
      <div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">yesterday</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">x_days_ago</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/one-line-tree-in-python/">one-line tree in python</a></h2>
      <time>Aug 30, 2012</time>
      <p>Brilliant:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="k">def</span> <span class="nf">tree</span><span class="p">():</span> <span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span></code></pre></div>
<p><a href="https://gist.github.com/2012250">https://gist.github.com/2012250</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-one-line-ftp/">python one-line ftp</a></h2>
      <time>Jun 3, 2012</time>
      <p>So, while looking for a quick and easy FTP server analog to this popular Python trick:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ python -m SimpleHTTPServer
Serving HTTP on <span class="m">0</span>.0.0.0 port <span class="m">8000</span> ...</code></pre></div>
<p>I found a <a href="http://stackoverflow.com/questions/4994638/one-line-ftp-server-in-python">Stackoverflow</a> post that shows Twisted has a one line FTP and
more:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ twistd -n ftp</code></pre></div>
<p>The <code>-n</code> option is for &ldquo;nodaemon&rdquo;; don&rsquo;t daemonize and run in the foreground.</p>

<p>Just looking at the options for <code>twistd</code>, it looks like you can also do
port-forwarding, SOCKS tunneling, a HTTP server, a DNS server, and more.</p>

<p><a href="http://twistedmatrix.com/trac/">http://twistedmatrix.com/trac/</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/less-print/">less print</a></h2>
      <time>Apr 8, 2012</time>
      <p>Excellent point:<br />
<a href="http://inventwithpython.com/blog/2012/04/06/stop-using-print-for-debugging-a-5-minute-quickstart-guide-to-pythons-logging-module/">http://inventwithpython.com/blog/2012/04/06/stop-using-print-for-debugging-a-5-minute-quickstart-guide-to-pythons-logging-module/</a></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> 
    <span class="n">format</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;message&#39;</span><span class="p">)</span></code></pre></div>
<p>In Ruby:</p>

<p><a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/logger/rdoc/Logger.html">http://www.ruby-doc.org/stdlib-1.9.3/libdoc/logger/rdoc/Logger.html</a></p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>

<span class="n">log</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">WARN</span>

<span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;Created logger&#34;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Program started&#34;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&#34;Nothing to do!&#34;</span><span class="p">)</span></code></pre></div>
    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/comparison-operator/">comparison operator</a></h2>
      <time>Mar 13, 2012</time>
      <p>Python doesn&rsquo;t have the &lt;=&gt; comparison operator, but this is the equivalent:</p>

<pre>
(a > b) - (a < b)
</pre>

<p><a href="http://docs.python.org/release/3.0.1/whatsnew/3.0.html">http://docs.python.org/release/3.0.1/whatsnew/3.0.html</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/drop-into-an-interactive-interpreter-from-a-script/">drop into an interactive interpreter from a script</a></h2>
      <time>Jan 30, 2012</time>
      <p>Twice this weekend I&rsquo;ve found that I would like to drop from a script into the
interactive prompt and have the environment and context available to debug and
test. Once in Ruby and once in Python.</p>

<p>I do most active development with an interpreter open, but copying and pasting
into the interpreter quickly becomes tedious.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pdb</span>
<span class="c1"># ...</span>
<span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;ruby-debug&#39;</span>
<span class="c1"># ...</span>
<span class="n">debugger</span></code></pre></div>
<p>I will certainly be using these extensively at the very least to test my
data-structures.</p>

<p><strong>Update 2012-10-11</strong></p>

<p>Alternative with Pry:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;pry&#39;</span>
<span class="c1"># ...</span>
<span class="nb">binding</span><span class="o">.</span><span class="n">pry</span></code></pre></div>
<p><a href="http://stackoverflow.com/questions/2158097/drop-into-python-interpreter-while-executing-function">http://stackoverflow.com/questions/2158097/drop-into-python-interpreter-while-executing-function</a>
<a href="http://stackoverflow.com/questions/1144560/how-do-i-drop-to-the-irb-prompt-from-a-running-script">http://stackoverflow.com/questions/1144560/how-do-i-drop-to-the-irb-prompt-from-a-running-script</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-unzip-idiom/">Python unzip idiom</a></h2>
      <time>Jan 30, 2012</time>
      <p>The <code>*splat</code> operator is commonly used to <strong>unzip</strong> arrays in Python:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">)</span>
<span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span></code></pre></div>
<p>I&rsquo;ve included another trick, the _ (underscore) is a shortcut in the
interactive interpreter for the last returned value, which works in irb too and
likely many others.</p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/python-child-reaping/">python child reaping</a></h2>
      <time>Jan 12, 2012</time>
      <p>When creating the &ldquo;hello world&rdquo; of socket programming, a forking echo
server/client, programmers often forget to reap child processes.</p>

<p>Interestingly, Wikipedia has a table of code for automatically reaping children
in several different languages.</p>

<p>In Python it is rather simple using the standard <code>SIG_IGN</code> handler:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span></code></pre></div>
<p><a href="http://docs.python.org/library/signal.html">http://docs.python.org/library/signal.html</a>
<a href="http://en.wikipedia.org/wiki/SIGCHLD">http://en.wikipedia.org/wiki/SIGCHLD</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/splat/">* splat</a></h2>
      <time>Dec 11, 2011</time>
      <p>Python has a seldom used unary operator that lets you &ldquo;flatten&rdquo; lists and
dictionaries into function arguments.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
  <span class="k">print</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">,</span><span class="n">c</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">li</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="o">*</span><span class="n">li</span><span class="p">)</span>
<span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span></code></pre></div>
<p>The * operator converts a dictionary to keyword arguments:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baz</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">quux</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="k">print</span> <span class="n">bar</span><span class="p">,</span> <span class="n">baz</span><span class="p">,</span> <span class="n">quux</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="sa"></span><span class="s2">&#34;bar&#34;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;baz&#34;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;quux&#34;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">foo</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
<span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span></code></pre></div>
<p>Simple, but useful.</p>

<p><a href="http://docs.python.org/tutorial/controlflow.html#unpacking-argument-lists">http://docs.python.org/tutorial/controlflow.html#unpacking-argument-lists</a></p>

    </article>
  
    <article>
      <h2><a href="//warrick.io/posts/binary-in-python/">Binary in Python</a></h2>
      <time>Dec 3, 2011</time>
      <p>Somehow, I often find myself wanting the binary representation of an integer.</p>

<p>Well, Python of course has the builtin bin function, but the output always
begins with a pesky <code>0b</code>.</p>

<p>Furthermore, bin doesn&rsquo;t support padding the binary to a certain length (e.g. 8
bits). So, I use string format:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="sa"></span><span class="s1">&#39;0b111111&#39;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="sa"></span><span class="s1">&#39;{0:08b}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span>
<span class="sa"></span><span class="s1">&#39;00111111&#39;</span></code></pre></div>
<p>Just for fun, here is a somewhat comical and more complicated example for
converting an ascii string to binary:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="sa"></span><span class="s2">&#34;foo&#34;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="sa"></span><span class="s2">&#34;{:08b}&#34;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
<span class="sa"></span><span class="s1">&#39;011001100110111101101111&#39;</span></code></pre></div>
<p>Format has many more features and reminds me of <code>printf</code> in some ways. I highly
recommend checking out the documentation.</p>

<p><a href="http://docs.python.org/library/string.html#format-specification-mini-language">http://docs.python.org/library/string.html#format-specification-mini-language</a></p>

    </article>
  

  </body>
</html>
