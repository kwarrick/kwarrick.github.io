<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>map reduce a csv file &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1>map reduce a csv file</h1>
  <span class="post-date">Sat, Jun 8, 2013</span>
    <p>Map-reduce a CSV files using the incredible UNIX <strong>sort</strong> utility in just
~24 LOC.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># kwarrick@uga.edu</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>

<span class="k">def</span> <span class="nf">map_reduce_csv</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
  <span class="sa"></span><span class="s2">&#34;&#34;&#34; Map-reduce CSV file using UNIX sort utility. &#34;&#34;&#34;</span>
  <span class="n">sort</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="p">[</span><span class="sa"></span><span class="s1">&#39;/usr/bin/sort&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;-t,&#39;</span><span class="p">],</span> 
    <span class="n">env</span><span class="o">=</span><span class="p">{</span><span class="sa"></span><span class="s1">&#39;LC_ALL&#39;</span><span class="p">:</span> <span class="sa"></span><span class="s1">&#39;C&#39;</span><span class="p">},</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="c1"># map and sort</span>
  <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">mapper</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

  <span class="n">sort</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1"># group and reduce</span>
  <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">sort</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONE</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">reducer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>

  <span class="n">sort</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
  <span class="sa"></span><span class="s2">&#34;&#34;&#34; Example task simply outputs sorted input file. &#34;&#34;&#34;</span>
  <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      
  <span class="k">def</span> <span class="nf">mapper</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="k">yield</span> <span class="n">row</span>

  <span class="k">def</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
      <span class="k">yield</span> <span class="n">value</span>

  <span class="n">map_reduce_csv</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="sa"></span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="kn">import</span> <span class="nn">fileinput</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;output.csv&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">identity</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="nb">input</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span></code></pre></div>
  </div>

  </body>
</html>
