<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>duck punching, in action &middot; warrick.io</title>

    <link rel="stylesheet" href="//warrick.io/css/jane.css">
    <link rel="stylesheet" href="//warrick.io/css/syntax.css">
    <link rel="stylesheet" href="//warrick.io/css/font-awesome.css">


    <link href="" rel="alternate" type="application/rss+xml" title="warrick.io" />
  </head>
  <body>
    
  <h1>duck punching, in action</h1>
  <span class="post-date">Mon, Oct 22, 2012</span>
    <p>Following up on last post, this post is about a monkey patch I wrote to get a
little more functionality out of one of Ruby&rsquo;s standard libraries, <code>Resolv</code>.</p>

<p><code>Resolv</code> is a DNS stub resolver library written in Ruby that provides the
ability to perform non-blocking DNS requests, but it doesn&rsquo;t expose any sort of
access to the raw DNS records returned, at least that I could tell.</p>

<p>So, after tracing the code, I found that copying an existing function,
modifying it very slightly, and patching it in was the easiest way to get in:</p>
<div class="highlight"><pre class="chroma"><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;resolv&#39;</span>

<span class="k">class</span> <span class="nc">Resolv</span><span class="o">::</span><span class="no">DNS</span>
  <span class="k">def</span> <span class="nc"></span><span class="o"></span><span class="nf">query</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">typeclass</span><span class="p">)</span>
    <span class="n">lazy_initialize</span>
    <span class="n">requester</span> <span class="o">=</span> <span class="n">make_udp_requester</span>
    <span class="n">senders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">begin</span>
      <span class="vi">@config</span><span class="o">.</span><span class="n">resolv</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">candidate</span><span class="p">,</span> <span class="n">tout</span><span class="p">,</span> <span class="n">nameserver</span><span class="p">,</span> <span class="n">port</span><span class="o">|</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="o">.</span><span class="n">new</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">rd</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="o"></span><span class="n">msg</span><span class="o">.</span><span class="n">add_question</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">typeclass</span><span class="p">)</span>
        <span class="k">unless</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">senders</span><span class="o">[[</span><span class="n">candidate</span><span class="p">,</span> <span class="n">nameserver</span><span class="p">,</span> <span class="n">port</span><span class="o">]]</span>
          <span class="n">sender</span> <span class="o">=</span> <span class="n">senders</span><span class="o">[[</span><span class="n">candidate</span><span class="p">,</span> <span class="n">nameserver</span><span class="p">,</span> <span class="n">port</span><span class="o">]]</span> <span class="o">=</span>
            <span class="n">requester</span><span class="o">.</span><span class="n">sender</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">nameserver</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">end</span>
        <span class="n">reply</span><span class="p">,</span> <span class="n">reply_name</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">tout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">rcode</span> <span class="o">==</span> <span class="no">RCode</span><span class="o">::</span><span class="no">NoError</span>
          <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">tc</span> <span class="o">==</span> <span class="mi">1</span> <span class="o"></span><span class="ow">and</span> <span class="ow">not</span> <span class="no">Requester</span><span class="o">::</span><span class="no">TCP</span> <span class="o">===</span> <span class="n">requester</span>
            <span class="n">requester</span><span class="o">.</span><span class="n">close</span>
            <span class="c1"># Retry via TCP:</span>
            <span class="n">requester</span> <span class="o">=</span> <span class="n">make_tcp_requester</span><span class="p">(</span><span class="n">nameserver</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
            <span class="n">senders</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">redo</span>
          <span class="k">end</span>
          <span class="k">return</span> <span class="n">reply</span> <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">ensure</span>
      <span class="n">requester</span><span class="o">.</span><span class="n">close</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">dns</span> <span class="o">=</span> <span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">.</span><span class="n">new</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&#34;segv.me&#34;</span><span class="p">,</span> <span class="no">Resolv</span><span class="o">::</span><span class="no">DNS</span><span class="o">::</span><span class="no">Resource</span><span class="o">::</span><span class="no">IN</span><span class="o">::</span><span class="n">A</span><span class="p">)</span>

<span class="n">resp</span><span class="o">.</span><span class="n">rcode</span>
<span class="o">=&gt;</span> <span class="mi">0</span>

<span class="o">[</span><span class="n">resp</span><span class="o">.</span><span class="n">encode</span><span class="o">].</span><span class="n">pack</span><span class="p">(</span><span class="s2">&#34;m*&#34;</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="s2">&#34;XYKBgAABAAEABQAABHNlZ3YCbWUAAAEAAcAMAAEAA...&#34;</span></code></pre></div>
<p>Of course this certainly isn&rsquo;t as full-featured as <code>Net::DNS</code>, the Perl analog,
but it doesn&rsquo;t require a gem as <code>Resolv</code> is part of the <code>stdlib</code>.</p>

  </div>

  </body>
</html>
